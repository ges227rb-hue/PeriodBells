// Google Apps Script: Code.gs
function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Timetables") || ss.insertSheet("Timetables");
  var data = JSON.parse(e.postData.contents);
  
  // Create a unique ID based on School, Type, and Day Type
  var id = data.schoolName + "|" + data.ttType + "|" + data.timeType;
  
  // Simple logic: Store the entire JSON string in one column or map it out
  // For this UI, we will store the raw JSON to make loading perfect
  var found = false;
  var lastRow = sheet.getLastRow();
  if (lastRow > 0) {
    var ids = sheet.getRange(1, 1, lastRow, 1).getValues();
    for (var i = 0; i < ids.length; i++) {
      if (ids[i][0] == id) {
        sheet.getRange(i + 1, 2).setValue(JSON.stringify(data));
        found = true;
        break;
      }
    }
  }
  
  if (!found) {
    sheet.appendRow([id, JSON.stringify(data)]);
  }
  
  return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Timetables");
  if (!sheet) return ContentService.createTextOutput("[]").setMimeType(ContentService.MimeType.JSON);
  
  var data = sheet.getDataRange().getValues();
  
  // If no params, return a list for the dropdowns
  if (!e.parameter.schoolName) {
    var list = data.map(function(row) {
      var obj = JSON.parse(row[1]);
      return { schoolName: obj.schoolName, ttType: obj.ttType, timeType: obj.timeType };
    });
    return ContentService.createTextOutput(JSON.stringify(list)).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Otherwise, find the specific timetable
  var searchId = e.parameter.schoolName + "|" + e.parameter.ttType + "|" + e.parameter.timeType;
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] == searchId) {
      return ContentService.createTextOutput(data[i][1]).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Not found"})).setMimeType(ContentService.MimeType.JSON);
}
